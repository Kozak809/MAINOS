<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Image Editor</title>
  <link rel="stylesheet" href="../../styles.css">
  <style>
    body { text-align: center; }
    .editor-controls { display: flex; flex-wrap: wrap; gap: 12px; justify-content: center; margin: 16px 0; }
    .editor-controls > * { min-width: 120px; }
    .canvas-container { display: flex; justify-content: center; align-items: center; margin: 16px 0; }
    canvas { background: #222; border-radius: 8px; box-shadow: var(--shadow-md); max-width: 100%; max-height: 60vh; }
    .hidden { display: none; }
    .palette-input { width: 60px; }
  </style>
</head>
<body>
  <div class="app-container">
    <h1>Image Editor</h1>
    <div class="upload-area" id="dropZone">
      <p>Перетащите изображение сюда или</p>
      <button class="btn btn-primary" id="uploadBtn">Выбрать файл</button>
      <input type="file" id="upload" accept="image/*">
    </div>
    <div class="editor-controls">
      <button class="btn" id="rotateLeftBtn">⟲ Повернуть влево</button>
      <button class="btn" id="rotateRightBtn">⟳ Повернуть вправо</button>
      <button class="btn" id="cropBtn">Кадрировать</button>
      <label>Палитра: <input type="color" id="paletteColor" class="palette-input"></label>
      <button class="btn" id="paletteBtn">Изменить палитру</button>
      <button class="btn" id="mergeBtn">Объединить с другим...</button>
      <input type="file" id="mergeInput" accept="image/*" class="hidden">
      <button class="btn btn-success" id="saveBtn">Сохранить</button>
    </div>
    <div class="canvas-container">
      <canvas id="editorCanvas" width="600" height="400"></canvas>
    </div>
    <div class="message message-error" id="errorMessage" style="display:none;"></div>
  </div>
  <script>
    const uploadInput = document.getElementById('upload');
    const uploadBtn = document.getElementById('uploadBtn');
    const dropZone = document.getElementById('dropZone');
    const canvas = document.getElementById('editorCanvas');
    const ctx = canvas.getContext('2d');
    const rotateLeftBtn = document.getElementById('rotateLeftBtn');
    const rotateRightBtn = document.getElementById('rotateRightBtn');
    const cropBtn = document.getElementById('cropBtn');
    const paletteColor = document.getElementById('paletteColor');
    const paletteBtn = document.getElementById('paletteBtn');
    const mergeBtn = document.getElementById('mergeBtn');
    const mergeInput = document.getElementById('mergeInput');
    const saveBtn = document.getElementById('saveBtn');
    const errorMessage = document.getElementById('errorMessage');

    let img = null;
    let imgDataUrl = null;
    let cropStart = null;
    let cropRect = null;
    let isCropping = false;

    // Drag & Drop и выбор файла
    uploadBtn.addEventListener('click', () => uploadInput.click());
    uploadInput.addEventListener('change', handleFileSelect);
    dropZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropZone.classList.add('dragover');
    });
    dropZone.addEventListener('dragleave', () => {
      dropZone.classList.remove('dragover');
    });
    dropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropZone.classList.remove('dragover');
      const file = e.dataTransfer.files[0];
      if (file && file.type.startsWith('image/')) {
        handleFile(file);
      }
    });

    function handleFileSelect(e) {
      const file = e.target.files[0];
      if (file) handleFile(file);
    }

    function handleFile(file) {
      const reader = new FileReader();
      reader.onload = e => {
        imgDataUrl = e.target.result;
        img = new window.Image();
        img.onload = () => {
          fitCanvasToImage();
          drawImage();
        };
        img.src = imgDataUrl;
      };
      reader.readAsDataURL(file);
    }

    function fitCanvasToImage() {
      if (!img) return;
      canvas.width = img.width;
      canvas.height = img.height;
    }

    function drawImage() {
      if (!img) return;
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
      if (isCropping && cropRect) {
        ctx.save();
        ctx.strokeStyle = 'red';
        ctx.lineWidth = 2;
        ctx.setLineDash([6, 4]);
        ctx.strokeRect(cropRect.x, cropRect.y, cropRect.w, cropRect.h);
        ctx.restore();
      }
    }

    // Поворот
    rotateLeftBtn.addEventListener('click', () => rotateImage(-90));
    rotateRightBtn.addEventListener('click', () => rotateImage(90));
    function rotateImage(deg) {
      if (!img) return;
      const radians = deg * Math.PI / 180;
      const offCanvas = document.createElement('canvas');
      const offCtx = offCanvas.getContext('2d');
      if (deg % 180 === 0) {
        offCanvas.width = img.width;
        offCanvas.height = img.height;
      } else {
        offCanvas.width = img.height;
        offCanvas.height = img.width;
      }
      offCtx.save();
      offCtx.translate(offCanvas.width / 2, offCanvas.height / 2);
      offCtx.rotate(radians);
      offCtx.drawImage(img, -img.width / 2, -img.height / 2);
      offCtx.restore();
      img = new window.Image();
      img.onload = () => {
        fitCanvasToImage();
        drawImage();
      };
      img.src = offCanvas.toDataURL();
    }

    // Кадрирование
    cropBtn.addEventListener('click', () => {
      if (!img) return;
      isCropping = true;
      cropRect = null;
      drawImage();
    });
    canvas.addEventListener('mousedown', (e) => {
      if (!isCropping) return;
      cropStart = getMousePos(e);
      cropRect = { x: cropStart.x, y: cropStart.y, w: 0, h: 0 };
      drawImage();
    });
    canvas.addEventListener('mousemove', (e) => {
      if (!isCropping || !cropStart) return;
      const pos = getMousePos(e);
      cropRect.w = pos.x - cropStart.x;
      cropRect.h = pos.y - cropStart.y;
      drawImage();
    });
    canvas.addEventListener('mouseup', (e) => {
      if (!isCropping || !cropRect) return;
      isCropping = false;
      // Кадрируем
      const { x, y, w, h } = cropRect;
      const offCanvas = document.createElement('canvas');
      offCanvas.width = Math.abs(w);
      offCanvas.height = Math.abs(h);
      const offCtx = offCanvas.getContext('2d');
      offCtx.drawImage(canvas, w < 0 ? x + w : x, h < 0 ? y + h : y, Math.abs(w), Math.abs(h), 0, 0, Math.abs(w), Math.abs(h));
      img = new window.Image();
      img.onload = () => {
        fitCanvasToImage();
        drawImage();
      };
      img.src = offCanvas.toDataURL();
      cropStart = null;
      cropRect = null;
    });
    function getMousePos(e) {
      const rect = canvas.getBoundingClientRect();
      return {
        x: Math.round((e.clientX - rect.left) * (canvas.width / rect.width)),
        y: Math.round((e.clientY - rect.top) * (canvas.height / rect.height))
      };
    }

    // Изменение палитры (простое тонирование)
    paletteBtn.addEventListener('click', () => {
      if (!img) return;
      const color = paletteColor.value;
      ctx.save();
      ctx.globalAlpha = 0.3;
      ctx.fillStyle = color;
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      ctx.restore();
      // Сохраняем изменения
      img = new window.Image();
      img.onload = () => {
        fitCanvasToImage();
        drawImage();
      };
      img.src = canvas.toDataURL();
    });

    // Объединение с другим изображением
    mergeBtn.addEventListener('click', () => mergeInput.click());
    mergeInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = ev => {
        const mergeImg = new window.Image();
        mergeImg.onload = () => {
          // Рисуем поверх
          ctx.drawImage(mergeImg, 0, 0, canvas.width, canvas.height);
          img = new window.Image();
          img.onload = () => {
            fitCanvasToImage();
            drawImage();
          };
          img.src = canvas.toDataURL();
        };
        mergeImg.src = ev.target.result;
      };
      reader.readAsDataURL(file);
    });

    // Сохранение
    saveBtn.addEventListener('click', () => {
      if (!img) return;
      const a = document.createElement('a');
      a.href = canvas.toDataURL('image/png');
      a.download = 'edited.png';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    });
  </script>
</body>
</html> 